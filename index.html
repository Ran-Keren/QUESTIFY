<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Questify Game</title>
<style>
  html, body {
    margin:0; padding:0;
    height:100%; width:100%;
    display:flex; justify-content:center; align-items:center;
    font-family:Arial, sans-serif; text-align:center;
    background:#fff;
    color:#222; flex-direction:column;
    overflow:hidden;
    touch-action:none;
  }
  
  #level1, #level2, #level3, #level4, #level5, #level6 {
    position:absolute;
    top:0; left:0;
    width:100%; height:100%;
    display:flex; justify-content:center; align-items:center;
    flex-direction:column;
  }
  
  #level3 { background:#00ff66; }
  #level4 { background:#f0f0f0; }
  #level5 { background:#fffae0; }
  #level6 { background:#cce7ff; }

  .hidden { display:none !important; }
  button {
    margin-top:20px;
    padding:10px 20px;
    font-size:1.2rem;
    border:none; border-radius:10px;
    background:#e94e77; color:white;
    cursor:pointer;
  }
  button:hover { background:#c53e63; }
  input {
    font-size:1.2rem; padding:10px;
    border-radius:10px; border:2px solid #333;
    text-align:center; width:180px;
  }
  #logo {
    max-width:40%;
    height:auto;
  }
  #level2 p { font-size:1.5rem; }
  #riddleText { font-size:1rem; }
  #level5 img {
    max-width:80%; max-height:80%;
    border-radius:20px; box-shadow:0 0 20px rgba(0,0,0,0.2);
  }
</style>
</head>
<body>

<!-- Level 1 -->
<div id="level1">
  <img id="logo" src="https://i.imgur.com/vl6pcuM.png" alt="Questify Logo">
  <button id="startBtn">Let's Start</button>
</div>

<!-- Level 2 -->
<div id="level2" class="hidden">
  <h2>Rules</h2>
  <p>1. You can use whatever you want.<br>
     2. You can't ask me for help.<br>
     3. There is no time limit.</p>
  <button id="micBtn">Allow Microphone</button>
  <button id="continueBtn" class="hidden">Start</button>
</div>

<!-- Level 3 -->
<div id="level3" class="hidden">
  <input id="colorInput" type="text" placeholder="" />
  <button id="submitColor">Submit</button>
</div>

<!-- Level 4 -->
<div id="level4" class="hidden">
  <h2 id="riddleText">
    I abide in stillness, poised for the fleeting instant, 
    Elation ripples through the unseen ether, 
    Tribute and reverence choreograph the way
  </h2>
  <p id="clapStatus"></p>
</div>

<!-- Level 5 -->
<div id="level5" class="hidden">
  <img id="level5Image" src="" alt="Level 5 Image">
  <div style="margin-top:20px;">
    <input id="secretInput" placeholder="" />
    <button id="checkSecret">Submit</button>
  </div>
  <p id="secretMessage" style="font-weight:bold;margin-top:10px;"></p>
</div>

<!-- Level 6 -->
<div id="level6" class="hidden">
  <h2> Youâ€™ve reached Level 4!</h2>
  <p>Well done, adventurer. The journey continues...</p>
</div>

<!-- EmailJS SDK -->
<script src="https://cdn.emailjs.com/dist/email.min.js"></script>
<script>
(function(){ emailjs.init("YOUR_USER_ID"); })(); // Replace with your EmailJS User ID
</script>

<script>
const l1 = document.getElementById("level1");
const l2 = document.getElementById("level2");
const l3 = document.getElementById("level3");
const l4 = document.getElementById("level4");
const l5 = document.getElementById("level5");
const l6 = document.getElementById("level6");
const startBtn = document.getElementById("startBtn");
const micBtn = document.getElementById("micBtn");
const continueBtn = document.getElementById("continueBtn");
const submitColor = document.getElementById("submitColor");
const colorInput = document.getElementById("colorInput");
const clapStatus = document.getElementById("clapStatus");
const level5Image = document.getElementById("level5Image");
const secretInput = document.getElementById("secretInput");
const checkSecret = document.getElementById("checkSecret");
const secretMessage = document.getElementById("secretMessage");

let audioContext, micStream, analyser, dataArray;
let animationFrameId;

const allowedColors = ['#00ff66', '#66ff00', '#00ff00', '00ff66', '66ff00', '00ff00'];
const level5Images = [
  "https://i.imgur.com/wIANnSO.jpeg",
  "https://i.imgur.com/SL7azLS.jpeg",
  "https://i.imgur.com/ksgaCXU.jpeg",
  "https://i.imgur.com/ZLkx3eu.jpeg"
];

// --- Email function ---
function sendLevelEmail(levelNumber) {
  emailjs.send("YOUR_SERVICE_ID", "YOUR_TEMPLATE_ID", {
    level: levelNumber,
    player: "Anonymous",
    date: new Date().toLocaleString()
  }).then(
    () => console.log("Email sent for level " + levelNumber),
    error => console.error("Email error:", error)
  );
}

// --- Level 1 ---
startBtn.onclick = () => {
  l1.classList.add("hidden");
  l2.classList.remove("hidden");
};

// --- Level 2 ---
micBtn.onclick = async () => {
  try {
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
    micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    const source = audioContext.createMediaStreamSource(micStream);
    analyser = audioContext.createAnalyser();
    analyser.fftSize = 512;
    dataArray = new Uint8Array(analyser.fftSize);
    source.connect(analyser);

    micBtn.classList.add("hidden");
    continueBtn.classList.remove("hidden");
  } catch (err) {
    console.warn("No microphone detected or access denied.", err);
    alert("No microphone detected. You can continue without it.");
    micBtn.classList.add("hidden");
    continueBtn.classList.remove("hidden");
  }
};

continueBtn.onclick = () => {
  l2.classList.add("hidden");
  l3.classList.remove("hidden");
  colorInput.focus();
};

// --- Level 3 ---
submitColor.onclick = () => {
  const guess = colorInput.value.trim().toLowerCase();
  const normalized = guess.startsWith('#') ? guess : '#' + guess;
  const isCorrect = allowedColors.some(c => c.replace('#','').toLowerCase() === normalized.replace('#',''));
  if (isCorrect) {
    l3.classList.add("hidden");
    l4.classList.remove("hidden");
    sendLevelEmail(3);
    startClapDetection();
  } else {
    alert("Try again!");
  }
};

// --- Level 4:  ---
function startClapDetection() {
  if (!analyser) return;

  let lastClapTime = 0;
  const doubleClapInterval = 600;
  const debounceTime = 250;
  let clapSequenceStartTime = 0;
  let clapsInSequence = 0;

  const threshold = 0.20;
  const spikeMultiplier = 2.2;
  let peakHistory = [];

  function detectClap() {
    analyser.getByteTimeDomainData(dataArray);
    let sum = 0, peak = 0;
    for (let i=0;i<dataArray.length;i++){
      const v=(dataArray[i]-128)/128;
      sum+=v*v;
      peak=Math.max(peak,Math.abs(v));
    }
    const rms=Math.sqrt(sum/dataArray.length);
    const now=Date.now();

    peakHistory.push(peak);
    if (peakHistory.length>5) peakHistory.shift();
    const avgPeak = peakHistory.reduce((a,b)=>a+b,0)/peakHistory.length;
    const isSuddenSpike = peak>avgPeak*spikeMultiplier;

    if (rms>threshold && isSuddenSpike && now-lastClapTime>debounceTime) {
      lastClapTime=now;

      if(clapsInSequence===0){
        clapsInSequence=1;
        clapSequenceStartTime=now;
      } else if(clapsInSequence===1){
        if(now-clapSequenceStartTime<=doubleClapInterval){
          clapsInSequence=2;
          clapStatus.textContent="ðŸ‘ Clap detected!";
          cancelAnimationFrame(animationFrameId);

          l4.classList.add("hidden");
          l5.classList.remove("hidden");
          updateLevel5Image();
          sendLevelEmail(5);
          return;
        } else {
          clapsInSequence=1;
          clapSequenceStartTime=now;
        }
      }
    }

    if(clapsInSequence===1 && now-clapSequenceStartTime>doubleClapInterval){
      clapsInSequence=0;
      clapSequenceStartTime=0;
    }

    if(clapsInSequence!==2){
      animationFrameId=requestAnimationFrame(detectClap);
    }
  }

  detectClap();
}

// --- Level 5:  ---
function updateLevel5Image() {
  const now = new Date();
  const minute = now.getMinutes();
  const index = Math.floor((minute % 40) / 10) % 4;
  level5Image.src = level5Images[index];
}
setInterval(() => {
  if (!l5.classList.contains("hidden")) updateLevel5Image();
}, 60000);

// --- Level 5 Secret Word ---
checkSecret.onclick = () => {
  const input = secretInput.value.trim().toLowerCase();
  if (input === "continue") {
    secretMessage.textContent = "âœ… Correct! Moving to Level 6...";
    setTimeout(() => {
      l5.classList.add("hidden");
      l6.classList.remove("hidden");
      sendLevelEmail(6);
    }, 1000);
  } else {
    secretMessage.textContent = "Try again";
  }
};
  
/* ---------- deterrent measures (option 3) ---------- */
const deterrentNotice = document.getElementById('deterrentNotice');
let deterrentTimeout = null;
function showDeterrentMessage(msg) {
  deterrentNotice.textContent = msg || 'Action blocked â€” this is a protected experience.';
  deterrentNotice.style.display = 'block';
  clearTimeout(deterrentTimeout);
  deterrentTimeout = setTimeout(() => {
    deterrentNotice.style.display = 'none';
  }, 2400);
}

// 1) Block right-click context menu
document.addEventListener('contextmenu', function(e) {
  e.preventDefault();
  showDeterrentMessage('Right-click is disabled on this page.');
});

// 2) Block common DevTools / view-source / save shortcuts
document.addEventListener('keydown', function(e) {
  // Normalized booleans
  const ctrl = e.ctrlKey || e.metaKey; // support CMD on macOS via metaKey
  const shift = e.shiftKey;
  const key = e.key ? e.key.toLowerCase() : '';

  // Block F12
  if (e.key === 'F12') {
    e.preventDefault();
    showDeterrentMessage('This action is disabled.');
    return false;
  }

  // Block Ctrl/Cmd + Shift + I / J / C (DevTools)
  if (ctrl && shift && (key === 'i' || key === 'j' || key === 'c')) {
    e.preventDefault();
    showDeterrentMessage('Opening developer tools is disabled.');
    return false;
  }

  // Block Ctrl/Cmd + U (view source)
  if (ctrl && key === 'u') {
    e.preventDefault();
    showDeterrentMessage('Viewing source is disabled.');
    return false;
  }

  // Block Ctrl/Cmd + S (save)
  if (ctrl && key === 's') {
    e.preventDefault();
    showDeterrentMessage('Saving this page is disabled.');
    return false;
  }

  // Block Ctrl/Cmd + Shift + C / K (inspect element / console shortcuts)
  if (ctrl && shift && (key === 'c' || key === 'k')) {
    e.preventDefault();
    showDeterrentMessage('This action is disabled.');
    return false;
  }

  // Block Ctrl/Cmd + Shift + R / F5 (hard reload) â€” just prevent default behaviour for key combos
  if ((ctrl && shift && key === 'r') || e.key === 'F5') {
    e.preventDefault();
    showDeterrentMessage('Reload disabled.');
    return false;
  }
});

// 3) Try to disable selection and dragging as extra deterrent (CSS + JS)
document.addEventListener('selectstart', function(e) { e.preventDefault(); });
document.addEventListener('dragstart', function(e) { e.preventDefault(); });

// 4) On-focus/blur note (optional): inform if user switches away (casual deterrent)
window.addEventListener('blur', () => {
  // small, non-blocking message when user switches out
  showDeterrentMessage('Focus lost â€” please stay in the game.');
});

/* ---------- end of deterrent measures ---------- */

</script>

</body>
</html>
