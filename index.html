<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Questify Game</title>
<style>
  html, body {
    margin:0; padding:0;
    height:100%; width:100%;
    display:flex; justify-content:center; align-items:center;
    font-family:Arial, sans-serif; text-align:center;
    background:#fff; /* Default white background */
    color:#222; flex-direction:column;
  }
  
  /* Critical Fix: Make Level 3 fill the entire screen and apply the green background */
  #level3 {
      background: #00ff66; /* Green Screen Color */
      /* These ensure it covers the whole screen */
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 10; 
      flex-direction:column;
      display: flex; /* Ensure content is centered */
      justify-content: center;
      align-items: center;
  }

  .hidden { display:none; }
  button {
    margin-top:20px;
    padding:10px 20px;
    font-size:1.2rem;
    border:none; border-radius:10px;
    background:#e94e77; color:white;
    cursor:pointer;
  }
  button:hover { background:#c53e63; }
  input {
    font-size:1.2rem; padding:10px;
    border-radius:10px; border:2px solid #333;
    text-align:center; width:150px;
  }
</style>
</head>
<body>

<div id="level1">
  <div style="font-size:3rem; color:red; font-weight:bold;">üîí Questify</div>
  <button id="startBtn">Let's Start</button>
</div>

<div id="level2" class="hidden">
  <h2>Rules</h2>
  <p>1. You can use whatever you want.<br>
     2. You can't ask me for help.<br>
     3. There is no time limit.</p>
  <button id="micBtn">Allow Microphone</button>
  <button id="continueBtn" class="hidden">Start</button>
</div>

<div id="level3" class="hidden">
  <input id="colorInput" type="text" placeholder="" />
  <button id="submitColor">Submit</button>
</div>

<div id="level4" class="hidden">
  <h2>üëè Double Clap to continue...</h2>
  <p id="clapStatus">A double clap will unlock the next level.</p>
</div>

<div id="level5" class="hidden">
  <h2>üéâ You passed the clap level!</h2>
</div>

<script>
const l1 = document.getElementById("level1");
const l2 = document.getElementById("level2");
const l3 = document.getElementById("level3");
const l4 = document.getElementById("level4");
const l5 = document.getElementById("level5");
const startBtn = document.getElementById("startBtn");
const micBtn = document.getElementById("micBtn");
const continueBtn = document.getElementById("continueBtn");
const submitColor = document.getElementById("submitColor");
const colorInput = document.getElementById("colorInput");
const clapStatus = document.getElementById("clapStatus");

let audioContext, micStream, analyser, dataArray, frequencyData;
const targetColor = '#00ff66'; 
let animationFrameId;

// --- Level 1 ---
startBtn.onclick = () => {
  l1.classList.add("hidden");
  l2.classList.remove("hidden");
};

// --- Level 2: Mic permission ---
micBtn.onclick = async () => {
  try {
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
    micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    const source = audioContext.createMediaStreamSource(micStream);
    analyser = audioContext.createAnalyser();
    
    // Use a larger FFT size for better frequency analysis
    analyser.fftSize = 1024; 
    dataArray = new Uint8Array(analyser.fftSize); // Time-domain data for RMS (loudness)
    frequencyData = new Uint8Array(analyser.frequencyBinCount); // Frequency data for filtering speech
    
    source.connect(analyser);

    micBtn.classList.add("hidden");
    continueBtn.classList.remove("hidden");
    clapStatus.textContent = "Microphone ready. Start the game.";
  } catch (err) {
    console.error(err);
    alert("Microphone access denied or unavailable.");
  }
};

continueBtn.onclick = () => {
  l2.classList.add("hidden");
  l3.classList.remove("hidden");
  colorInput.focus();
};

// --- Level 3: Color input ---
submitColor.onclick = () => {
  const guess = colorInput.value.trim();
  const normalized = guess.startsWith('#') ? guess : '#' + guess;
  if (normalized.toLowerCase() === targetColor.toLowerCase()) {
    l3.classList.add("hidden");
    l4.classList.remove("hidden");
    startClapDetection();
  } else {
    alert("‚ùå Wrong color! Try again.");
  }
};

// --- Level 4: Clap detection (Fixed for Double Clap & Speech Filter) ---
function startClapDetection() {
  if (!analyser) return;

  let lastClapTime = 0;
  const doubleClapInterval = 600; 
  const debounceTime = 200; 
  let clapSequenceStartTime = 0;
  let clapsInSequence = 0;
  
  // Audio Thresholds (Higher threshold requires louder sound)
  const rmsThreshold = 0.20; 
  // Frequency Filter: Claps have energy across many frequencies. 
  // We check for energy in the mid-high range (> 2kHz) where speech drops off.
  const frequencyThreshold = 100; // How much energy must be present in the high-frequency band (0-255)
  const highFreqStart = Math.floor(2000 / (audioContext.sampleRate / analyser.fftSize)); 

  function detectClap() {
    analyser.getByteTimeDomainData(dataArray);
    analyser.getByteFrequencyData(frequencyData);

    // 1. Calculate RMS (Loudness)
    let sum = 0;
    for (let i = 0; i < dataArray.length; i++) {
      const v = (dataArray[i] - 128) / 128;
      sum += v * v;
    }
    const rms = Math.sqrt(sum / dataArray.length);

    // 2. Check for High Frequency Content (Filter out deep speech/whispers)
    let highFreqEnergy = 0;
    for (let i = highFreqStart; i < analyser.frequencyBinCount; i++) {
        highFreqEnergy += frequencyData[i];
    }
    const avgHighFreqEnergy = highFreqEnergy / (analyser.frequencyBinCount - highFreqStart);

    const now = Date.now();

    // Check if loud enough AND has enough high-frequency content AND is outside the debounce period
    if (rms > rmsThreshold && avgHighFreqEnergy > frequencyThreshold && now - lastClapTime > debounceTime) {
      // --- CLAP DETECTED ---
      lastClapTime = now;
      
      if (clapsInSequence === 0) {
        clapsInSequence = 1;
        clapSequenceStartTime = now;
        clapStatus.textContent = "üëè First clap detected! Clap again quickly...";
      } else if (clapsInSequence === 1) {
        if (now - clapSequenceStartTime <= doubleClapInterval) {
          // SUCCESSFUL DOUBLE CLAP
          clapsInSequence = 2; 
          clapStatus.textContent = "üéâ Double clap detected! Level passed!";
          cancelAnimationFrame(animationFrameId);
          
          setTimeout(() => {
            l4.classList.add("hidden");
            l5.classList.remove("hidden");
          }, 500);
          return; 
        } else {
          // Too slow, restart sequence
          clapsInSequence = 1;
          clapSequenceStartTime = now;
          clapStatus.textContent = "üëè Too slow! First clap detected again. Clap quickly!";
        }
      }
    }

    // Reset sequence if too much time passes since the first clap
    if (clapsInSequence === 1 && now - clapSequenceStartTime > doubleClapInterval) {
        clapsInSequence = 0;
        clapSequenceStartTime = 0;
        clapStatus.textContent = "A double clap will unlock the next level.";
    }

    // Continue the loop
    if (clapsInSequence !== 2) {
        animationFrameId = requestAnimationFrame(detectClap);
    }
  }

  detectClap();
}

</script>

</body>
</html>
