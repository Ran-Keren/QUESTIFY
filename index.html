<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Questify Game</title>
<style>
Â  html, body {
Â  Â  margin:0; padding:0;
Â  Â  height:100%; width:100%;
Â  Â  display:flex; justify-content:center; align-items:center;
Â  Â  font-family:Arial, sans-serif; text-align:center;
Â  Â  background:#fff;
Â  Â  color:#222; flex-direction:column;
Â  }
Â Â 
Â  #level1, #level2, #level3, #level4, #level5 {
Â  Â  position: absolute;
Â  Â  top: 0;
Â  Â  left: 0;
Â  Â  width: 100%;
Â  Â  height: 100%;
Â  Â  display: flex;
Â  Â  justify-content: center;
Â  Â  align-items: center;
Â  Â  flex-direction: column;
Â  }
Â Â 
Â  #level3 { background: #00ff66; }

Â  .hidden { display:none !important; }
Â  button {
Â  Â  margin-top:20px;
Â  Â  padding:10px 20px;
Â  Â  font-size:1.2rem;
Â  Â  border:none; border-radius:10px;
Â  Â  background:#e94e77; color:white;
Â  Â  cursor:pointer;
Â  }
Â  button:hover { background:#c53e63; }
Â  input {
Â  Â  font-size:1.2rem; padding:10px;
Â  Â  border-radius:10px; border:2px solid #333;
Â  Â  text-align:center; width:150px;
Â  }
</style>
</head>
<body>

<div id="level1">
Â  <div style="font-size:3rem; color:red; font-weight:bold;">ğŸ”’ Questify</div>
Â  <button id="startBtn">Let's Start</button>
</div>

<div id="level2" class="hidden">
Â  <h2>Rules</h2>
Â  <p>1. You can use whatever you want.<br>
Â  Â  Â 2. You can't ask me for help.<br>
Â  Â  Â 3. There is no time limit.</p>
Â  <button id="micBtn">Allow Microphone</button>
Â  <button id="continueBtn" class="hidden">Start</button>
</div>

<div id="level3" class="hidden">
Â  <input id="colorInput" type="text" placeholder="" />
Â  <button id="submitColor">Submit</button>
</div>

<div id="level4" class="hidden">
Â  <h2>"I abide in stillness, poised for the fleeting instant, Elation ripples through the unseen ether, Tribute and reverence choreograph the way"</h2>
Â  <p id="clapStatus">A double clap will unlock the next level.</p>
</div>

<div id="level5" class="hidden">
Â  <h2>Level Complete!</h2>
Â  <p id="timeDisplay"></p>
</div>

<script src="https://cdn.emailjs.com/dist/email.min.js"></script>
<script>
(function(){ emailjs.init("YOUR_USER_ID"); })(); // Replace with your EmailJS User ID
</script>

<script>
const l1 = document.getElementById("level1");
const l2 = document.getElementById("level2");
const l3 = document.getElementById("level3");
const l4 = document.getElementById("level4");
const l5 = document.getElementById("level5");
const startBtn = document.getElementById("startBtn");
const micBtn = document.getElementById("micBtn");
const continueBtn = document.getElementById("continueBtn");
const submitColor = document.getElementById("submitColor");
const colorInput = document.getElementById("colorInput");
const clapStatus = document.getElementById("clapStatus");
const timeDisplay = document.getElementById("timeDisplay");

let audioContext, micStream, analyser, dataArray;
const targetColor = '#00ff66';Â 
let animationFrameId;

function sendLevelEmail(levelNumber) {
Â  emailjs.send("YOUR_SERVICE_ID", "YOUR_TEMPLATE_ID", {
Â  Â  level: levelNumber,
Â  Â  player: "Anonymous",
Â  Â  date: new Date().toLocaleString()
Â  }).then(
Â  Â  response => console.log("Email sent for level " + levelNumber),
Â  Â  error => console.error("Email error:", error)
Â  );
}

// Function to get the current rounded hour (12-hour format)
function getRoundedHour() {
Â  const now = new Date();
Â  const hour = now.getHours();
Â  const roundedHour = hour % 12 || 12; // Convert to 12-hour format, 0 becomes 12
Â  const ampm = hour >= 12 ? 'PM' : 'AM';
Â  return `${roundedHour}:00 ${ampm}`;
}

// --- Level 1 ---
startBtn.onclick = () => {
Â  l1.classList.add("hidden");
Â  l2.classList.remove("hidden");
Â  // Email removed for level 1
};

// --- Level 2 ---
micBtn.onclick = async () => {
Â  try {
Â  Â  audioContext = new (window.AudioContext || window.webkitAudioContext)();
Â  Â  micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
Â  Â  const source = audioContext.createMediaStreamSource(micStream);
Â  Â  analyser = audioContext.createAnalyser();
Â  Â  analyser.fftSize = 512;
Â  Â  dataArray = new Uint8Array(analyser.fftSize);
Â  Â  source.connect(analyser);

Â  Â  micBtn.classList.add("hidden");
Â  Â  continueBtn.classList.remove("hidden");
Â  } catch (err) {
Â  Â  console.error(err);
Â  Â  alert("Microphone access denied or unavailable.");
Â  }
};

continueBtn.onclick = () => {
Â  l2.classList.add("hidden");
Â  l3.classList.remove("hidden");
Â  colorInput.focus();
Â  // Email removed for level 2
};

// --- Level 3 ---
submitColor.onclick = () => {
Â  const guess = colorInput.value.trim();
Â  const normalized = guess.startsWith('#') ? guess : '#' + guess;
Â  if (normalized.toLowerCase() === targetColor.toLowerCase()) {
Â  Â  l3.classList.add("hidden");
Â  Â  l4.classList.remove("hidden");
Â  Â  sendLevelEmail(3); // send email after level 3
Â  Â  startClapDetection();
Â  }Â 
Â  // Removed alert for wrong color
};

// --- Level 4: Clap Detection ---
function startClapDetection() {
Â  if (!analyser) return;

Â  let lastClapTime = 0;
Â  const doubleClapInterval = 600;
Â  const debounceTime = 250;
Â  let clapSequenceStartTime = 0;
Â  let clapsInSequence = 0;

Â  const threshold = 0.35;Â  Â  Â  // reduced threshold
Â  const spikeMultiplier = 2.2; // slightly more sensitive
Â  let peakHistory = [];

Â  function detectClap() {
Â  Â  analyser.getByteTimeDomainData(dataArray);
Â  Â  let sum = 0, peak = 0;
Â  Â  for (let i=0;i<dataArray.length;i++){
Â  Â  Â  const v=(dataArray[i]-128)/128;
Â  Â  Â  sum+=v*v;
Â  Â  Â  peak=Math.max(peak,Math.abs(v));
Â  Â  }
Â  Â  const rms=Math.sqrt(sum/dataArray.length);
Â  Â  const now=Date.now();

Â  Â  peakHistory.push(peak);
Â  Â  if (peakHistory.length>5) peakHistory.shift();
Â  Â  const avgPeak = peakHistory.reduce((a,b)=>a+b,0)/peakHistory.length;
Â  Â  const isSuddenSpike = peak>avgPeak*spikeMultiplier;

Â  Â  if (rms>threshold && isSuddenSpike && now-lastClapTime>debounceTime) {
Â  Â  Â  lastClapTime=now;
Â  Â  Â  if(clapsInSequence===0){
Â  Â  Â  Â  clapsInSequence=1;
Â  Â  Â  Â  clapSequenceStartTime=now;
Â  Â  Â  Â  clapStatus.textContent="ğŸ‘ Detected first peak. Get ready for the second...";
Â  Â  Â  } else if(clapsInSequence===1){
Â  Â  Â  Â  if(now-clapSequenceStartTime<=doubleClapInterval){
Â  Â  Â  Â  Â  clapsInSequence=2;
Â  Â  Â  Â  Â  clapStatus.textContent="âœ… Correct Answer! Proceeding...";
Â  Â  Â  Â  Â  cancelAnimationFrame(animationFrameId);
Â  Â  Â  Â  Â  sendLevelEmail(4); // send email after level 4
Â  Â  Â  Â  Â  setTimeout(()=>{
Â  Â  Â  Â  Â  Â  l4.classList.add("hidden");
Â  Â  Â  Â  Â  Â  l5.classList.remove("hidden");
Â  Â  Â  Â  Â  Â  timeDisplay.textContent = `The current rounded hour is: ${getRoundedHour()}`;
Â  Â  Â  Â  Â  Â  sendLevelEmail(5); // send email after final level
Â  Â  Â  Â  Â  },500);
Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  clapsInSequence=1;
Â  Â  Â  Â  Â  clapSequenceStartTime=now;
Â  Â  Â  Â  Â  clapStatus.textContent="ğŸ‘ Too slow! First peak detected again. Try quicker!";
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  }

Â  Â  if(clapsInSequence===1 && now-clapSequenceStartTime>doubleClapInterval){
Â  Â  Â  clapsInSequence=0;
Â  Â  Â  clapSequenceStartTime=0;
Â  Â  Â  clapStatus.textContent="A double clap will unlock the next level.";
Â  Â  }

Â  Â  if(clapsInSequence!==2){
Â  Â  Â  animationFrameId=requestAnimationFrame(detectClap);
Â  Â  }
Â  }

Â  detectClap();
}

</script>

</body>
</html>
